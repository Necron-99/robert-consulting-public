name: Automated Blog Generation

on:
  schedule:
    - cron: '0 9 * * 1-5'  # Run at 9 AM Monday-Friday
  workflow_dispatch:
    inputs:
      day:
        description: 'Day of the week to generate blog for'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - monday
          - tuesday
          - wednesday
          - thursday
          - friday
      dryrun:
        description: 'Run in dry-run mode (no actual content creation)'
        required: false
        default: false
        type: boolean

jobs:
  generate-blog:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
          
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          
      - name: Determine blog day
        id: blog-day
        run: |
          if [ "${{ github.event.inputs.day }}" = "auto" ] || [ -z "${{ github.event.inputs.day }}" ]; then
            DAY=$(date +%A | tr '[:upper:]' '[:lower:]')
          else
            DAY="${{ github.event.inputs.day }}"
          fi
          echo "day=$DAY" >> $GITHUB_OUTPUT
          echo "üìÖ Generating blog for: $DAY"
          
      - name: Generate blog content
        id: generate-content
        run: |
          set -e  # Exit on any error
          
          DAY="${{ steps.blog-day.outputs.day }}"
          DATE=$(date +%Y-%m-%d)
          BLOG_FILENAME="website/blog-posts/${DAY}-${DATE}.html"
          DRYRUN="${{ github.event.inputs.dryrun }}"
          
          echo "üîç Debug info:"
          echo "  DAY: $DAY"
          echo "  DATE: $DATE"
          echo "  BLOG_FILENAME: $BLOG_FILENAME"
          echo "  DRYRUN: $DRYRUN"
          echo "  Script exists: $(ls -la scripts/generate-detailed-blog.sh)"
          
          # Set topic and focus based on day
          case "$DAY" in
            "monday")
              TOPIC="AWS Services and Updates"
              FOCUS="Latest AWS releases, feature updates, impact analysis"
              KEYWORDS="AWS, cloud services, updates, new features, AWS announcements"
              ;;
            "tuesday")
              TOPIC="AIOps"
              FOCUS="Artificial Intelligence for IT Operations, predictive analytics, automation"
              KEYWORDS="AIOps, machine learning, IT operations, automation, predictive analytics"
              ;;
            "wednesday")
              TOPIC="Intelligent Vulnerability Remediation"
              FOCUS="AI-powered security, threat detection, automated remediation"
              KEYWORDS="vulnerability management, security automation, AI security, threat detection, remediation"
              ;;
            "thursday")
              TOPIC="OpenTofu Analysis"
              FOCUS="Comprehensive comparison with Terraform, pros/cons, migration strategies"
              KEYWORDS="OpenTofu, Terraform, infrastructure as code, open source, comparison"
              ;;
            "friday")
              TOPIC="Platform Market Analysis"
              FOCUS="Domo, OpenShift, and other enterprise platform players"
              KEYWORDS="Domo, OpenShift, platform comparison, enterprise platforms, market analysis"
              ;;
            *)
              echo "‚ùå Invalid day: $DAY"
              exit 1
              ;;
          esac
          
          echo "üìù Topic details:"
          echo "  TOPIC: $TOPIC"
          echo "  FOCUS: $FOCUS"
          echo "  KEYWORDS: $KEYWORDS"
          
          if [ "$DRYRUN" = "true" ]; then
            echo "üß™ DRY RUN MODE - No content will be created"
            echo "üìã Would create: $BLOG_FILENAME"
            echo "üìã Topic: $TOPIC"
            echo "üìã Focus: $FOCUS"
            echo "üìã Keywords: $KEYWORDS"
            echo "‚úÖ Dry run completed successfully"
            echo "blog-generated=false" >> $GITHUB_OUTPUT
            echo "blog-filename=dryrun" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Create directory if it doesn't exist
          mkdir -p website/blog-posts
          
          # Use the external script to generate detailed content
          echo "üöÄ Running blog generation script..."
          bash scripts/generate-detailed-blog.sh "$DAY" "$TOPIC" "$FOCUS" "$KEYWORDS" "$DATE" "$BLOG_FILENAME"
          
          # Verify the file was created
          if [ -f "$BLOG_FILENAME" ]; then
            echo "‚úÖ Blog file created successfully: $BLOG_FILENAME"
            echo "üìä File size: $(wc -c < "$BLOG_FILENAME") bytes"
          else
            echo "‚ùå Blog file was not created!"
            exit 1
          fi
          
          echo "blog-generated=true" >> $GITHUB_OUTPUT
          echo "blog-filename=$BLOG_FILENAME" >> $GITHUB_OUTPUT
          echo "‚úÖ Blog generated: $BLOG_FILENAME"
          
      - name: Upload to S3
        if: steps.generate-content.outputs.blog-generated == 'true'
        run: |
          set -e  # Exit on any error
          
          BLOG_FILENAME="${{ steps.generate-content.outputs.blog-filename }}"
          
          echo "üì§ Uploading to S3: $BLOG_FILENAME"
          echo "üîç File exists: $(ls -la "$BLOG_FILENAME")"
          
          # Upload to S3
          aws s3 cp "$BLOG_FILENAME" "s3://robert-consulting-website/blog-posts/" --debug
          
          echo "‚úÖ Successfully uploaded to S3: $BLOG_FILENAME"
          
      - name: Invalidate CloudFront
        if: steps.generate-content.outputs.blog-generated == 'true'
        run: |
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/blog-posts/*"
          echo "üîÑ CloudFront cache invalidated"
          
      - name: Commit and push changes
        if: steps.generate-content.outputs.blog-generated == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          git commit -m "üìù Auto-generated blog post for ${{ steps.blog-day.outputs.day }}"
          git push origin main
          echo "‚úÖ Changes committed and pushed"