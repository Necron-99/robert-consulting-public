name: Automated Blog Generation

on:
  schedule:
    - cron: '0 9 * * 1-5'  # Run at 9 AM Monday-Friday
  workflow_dispatch:
    inputs:
      day:
        description: 'Day of the week to generate blog for'
        required: false
        default: 'auto'
        type: choice
        options:
          - auto
          - monday
          - tuesday
          - wednesday
          - thursday
          - friday
      dryrun:
        description: 'Run in dry-run mode (no actual content creation)'
        required: false
        default: false
        type: boolean

jobs:
  generate-blog:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'
          
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
          
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq
          
      - name: Determine blog day
        id: blog-day
        run: |
          if [ "${{ github.event.inputs.day }}" = "auto" ] || [ -z "${{ github.event.inputs.day }}" ]; then
            DAY=$(date +%A | tr '[:upper:]' '[:lower:]')
          else
            DAY="${{ github.event.inputs.day }}"
          fi
          echo "day=$DAY" >> $GITHUB_OUTPUT
          echo "üìÖ Generating blog for: $DAY"
          
      - name: Generate blog content
        id: generate-content
        run: |
          set -e  # Exit on any error
          
          DAY="${{ steps.blog-day.outputs.day }}"
          DATE=$(date +%Y-%m-%d)
          BLOG_FILENAME="website/blog-posts/${DAY}-${DATE}.html"
          DRYRUN="${{ github.event.inputs.dryrun }}"
          
          echo "üîç Debug info:"
          echo "  DAY: $DAY"
          echo "  DATE: $DATE"
          echo "  BLOG_FILENAME: $BLOG_FILENAME"
          echo "  DRYRUN: $DRYRUN"
          echo "  Script exists: $(ls -la scripts/generate-detailed-blog.sh)"
          
          # Set topic and focus based on day
          case "$DAY" in
            "monday")
              TOPIC="AWS Services and Updates"
              FOCUS="Latest AWS releases, feature updates, impact analysis"
              KEYWORDS="AWS, cloud services, updates, new features, AWS announcements"
              ;;
            "tuesday")
              TOPIC="AIOps"
              FOCUS="Artificial Intelligence for IT Operations, predictive analytics, automation"
              KEYWORDS="AIOps, machine learning, IT operations, automation, predictive analytics"
              ;;
            "wednesday")
              TOPIC="Intelligent Vulnerability Remediation"
              FOCUS="AI-powered security, threat detection, automated remediation"
              KEYWORDS="vulnerability management, security automation, AI security, threat detection, remediation"
              ;;
            "thursday")
              TOPIC="OpenTofu Analysis"
              FOCUS="Comprehensive comparison with Terraform, pros/cons, migration strategies"
              KEYWORDS="OpenTofu, Terraform, infrastructure as code, open source, comparison"
              ;;
            "friday")
              TOPIC="Platform Market Analysis"
              FOCUS="Domo, OpenShift, and other enterprise platform players"
              KEYWORDS="Domo, OpenShift, platform comparison, enterprise platforms, market analysis"
              ;;
            *)
              echo "‚ùå Invalid day: $DAY"
              exit 1
              ;;
          esac
          
          echo "üìù Topic details:"
          echo "  TOPIC: $TOPIC"
          echo "  FOCUS: $FOCUS"
          echo "  KEYWORDS: $KEYWORDS"
          
          if [ "$DRYRUN" = "true" ]; then
            echo "üß™ DRY RUN MODE - No content will be created"
            echo "üìã Would create: $BLOG_FILENAME"
            echo "üìã Topic: $TOPIC"
            echo "üìã Focus: $FOCUS"
            echo "üìã Keywords: $KEYWORDS"
            echo "‚úÖ Dry run completed successfully"
            echo "blog-generated=false" >> $GITHUB_OUTPUT
            echo "blog-filename=dryrun" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Create directory if it doesn't exist
          mkdir -p website/blog-posts
          
          # Use the external script to generate detailed content
          echo "üöÄ Running blog generation script..."
          bash scripts/generate-detailed-blog.sh "$DAY" "$TOPIC" "$FOCUS" "$KEYWORDS" "$DATE" "$BLOG_FILENAME"
          
          # Verify the file was created
          if [ -f "$BLOG_FILENAME" ]; then
            echo "‚úÖ Blog file created successfully: $BLOG_FILENAME"
            echo "üìä File size: $(wc -c < "$BLOG_FILENAME") bytes"
          else
            echo "‚ùå Blog file was not created!"
            exit 1
          fi
          
          echo "blog-generated=true" >> $GITHUB_OUTPUT
          echo "blog-filename=$BLOG_FILENAME" >> $GITHUB_OUTPUT
          echo "blog-topic=$TOPIC" >> $GITHUB_OUTPUT
          echo "blog-focus=$FOCUS" >> $GITHUB_OUTPUT
          echo "blog-keywords=$KEYWORDS" >> $GITHUB_OUTPUT
          echo "‚úÖ Blog generated: $BLOG_FILENAME"
          
      - name: Update blog.js with new post
        if: steps.generate-content.outputs.blog-generated == 'true'
        run: |
          set -e
          
          DAY="${{ steps.blog-day.outputs.day }}"
          BLOG_FILENAME="${{ steps.generate-content.outputs.blog-filename }}"
          DATE_ONLY=$(echo "$BLOG_FILENAME" | grep -oE '[0-9]{4}-[0-9]{2}-[0-9]{2}' || date +%Y-%m-%d)
          TOPIC="${{ steps.generate-content.outputs.blog-topic }}"
          FOCUS="${{ steps.generate-content.outputs.blog-focus }}"
          KEYWORDS="${{ steps.generate-content.outputs.blog-keywords }}"
          BLOG_JS="website/js/blog.js"
          
          echo "üìù Updating blog.js with new post entry..."
          echo "   Day: $DAY"
          echo "   Date: $DATE_ONLY"
          echo "   Topic: $TOPIC"
          
          # Determine category, icon, and tags based on topic
          case "$TOPIC" in
            "AWS Services and Updates")
              CATEGORY="aws"
              ICON="‚òÅÔ∏è"
              TAGS_STR="['AWS', 'Cloud Services', 'Updates', 'New Features', 'AWS Announcements']"
              READ_TIME="12 min read"
              ;;
            "AIOps")
              CATEGORY="aiops"
              ICON="ü§ñ"
              TAGS_STR="['AIOps', 'Machine Learning', 'IT Operations', 'Automation', 'Predictive Analytics']"
              READ_TIME="10 min read"
              ;;
            "Intelligent Vulnerability Remediation")
              CATEGORY="security"
              ICON="üîí"
              TAGS_STR="['Vulnerability Management', 'Security Automation', 'AI Security', 'Threat Detection', 'Remediation']"
              READ_TIME="8 min read"
              ;;
            "OpenTofu Analysis")
              CATEGORY="infrastructure"
              ICON="üèóÔ∏è"
              TAGS_STR="['OpenTofu', 'Terraform', 'Infrastructure as Code', 'Open Source', 'Comparison']"
              READ_TIME="10 min read"
              ;;
            "Platform Market Analysis")
              CATEGORY="platform"
              ICON="üìä"
              TAGS_STR="['Platform Analysis', 'Domo', 'OpenShift', 'Enterprise Platforms', 'Market Analysis']"
              READ_TIME="9 min read"
              ;;
            *)
              CATEGORY="general"
              ICON="üìù"
              TAGS_STR="['Technology', 'Analysis']"
              READ_TIME="8 min read"
              ;;
          esac
          
          # Extract title from the blog post HTML
          TITLE=$(grep -oE '<h1>[^<]+</h1>' "$BLOG_FILENAME" | sed 's/<h1>//;s/<\/h1>//' || echo "$TOPIC")
          
          # Create excerpt from focus (first 100 chars)
          EXCERPT=$(echo "$FOCUS" | cut -c1-100)
          if [ ${#FOCUS} -gt 100 ]; then
            EXCERPT="${EXCERPT}..."
          fi
          
          # Capitalize first letter of day for comment
          DAY_CAP=$(echo "$DAY" | sed 's/^./\U&/')
          
          # Use Node.js to update blog.js (more reliable than sed for JSON-like structures)
          # Create a temporary Node.js script to avoid YAML quoting issues
          cat > /tmp/update-blog.js << 'NODE_SCRIPT'
          const fs = require('fs');
          const day = process.env.DAY;
          const dateOnly = process.env.DATE_ONLY;
          const title = process.env.TITLE;
          const excerpt = process.env.EXCERPT;
          const category = process.env.CATEGORY;
          const tagsStr = process.env.TAGS_STR;
          const icon = process.env.ICON;
          const readTime = process.env.READ_TIME;
          const dayCap = process.env.DAY_CAP;
          const blogJs = process.env.BLOG_JS;
          
          const blogJsContent = fs.readFileSync(blogJs, 'utf8');
          
          // Find max ID
          const idMatches = blogJsContent.match(/id: (\d+)/g) || [];
          const maxId = Math.max(...idMatches.map(m => parseInt(m.match(/\d+/)[0])));
          const nextId = maxId + 1;
          
          // Find the insertion point (before the closing bracket)
          const insertPoint = blogJsContent.lastIndexOf('    }');
          if (insertPoint === -1) {
            console.error('‚ùå Could not find insertion point');
            process.exit(1);
          }
          
          // Add comma to last entry if needed
          let updatedBlogJs = blogJsContent;
          const beforeInsert = blogJsContent.substring(0, insertPoint);
          const afterInsert = blogJsContent.substring(insertPoint);
          
          // Check if last entry has comma
          if (!beforeInsert.trimEnd().endsWith(',')) {
            // Find the last entry's closing brace and add comma
            updatedBlogJs = beforeInsert.replace(/(\s+})\s*$/, '$1,') + afterInsert;
          }
          
          // Create new entry
          const newEntry = \`      {
        id: \${nextId},
        title: '\${title.replace(/'/g, "\\\\'")}',
        excerpt: '\${excerpt.replace(/'/g, "\\\\'")}',
        content: 'blog-posts/\${day}-\${dateOnly}.html',
        date: '\${dateOnly}', // \${dayCap}
        category: '\${category}',
        tags: \${tagsStr},
        icon: '\${icon}',
        readTime: '\${readTime}'
      }\`;
          
          // Insert new entry before the closing bracket
          const finalInsertPoint = updatedBlogJs.lastIndexOf('    }');
          const finalBefore = updatedBlogJs.substring(0, finalInsertPoint);
          const finalAfter = updatedBlogJs.substring(finalInsertPoint);
          
          const result = finalBefore + newEntry + ',\n' + finalAfter;
          
          fs.writeFileSync(blogJs, result, 'utf8');
          console.log('‚úÖ Added blog entry to blog.js:');
          console.log('   ID:', nextId);
          console.log('   Title:', title);
          console.log('   Date:', dateOnly);
          console.log('   Category:', category);
NODE_SCRIPT
          
          # Run the Node.js script with environment variables
          DAY="$DAY" \
          DATE_ONLY="$DATE_ONLY" \
          TITLE="$(echo "$TITLE" | sed "s/'/\\\\'/g")" \
          EXCERPT="$(echo "$EXCERPT" | sed "s/'/\\\\'/g")" \
          CATEGORY="$CATEGORY" \
          TAGS_STR="$TAGS_STR" \
          ICON="$ICON" \
          READ_TIME="$READ_TIME" \
          DAY_CAP="$DAY_CAP" \
          BLOG_JS="$BLOG_JS" \
          node /tmp/update-blog.js
          
          # Clean up
          rm -f /tmp/update-blog.js
          
      - name: Upload to S3
        if: steps.generate-content.outputs.blog-generated == 'true'
        run: |
          set -e  # Exit on any error
          
          BLOG_FILENAME="${{ steps.generate-content.outputs.blog-filename }}"
          
          echo "üì§ Uploading to S3: $BLOG_FILENAME"
          echo "üîç File exists: $(ls -la "$BLOG_FILENAME")"
          
          # Upload to S3
          aws s3 cp "$BLOG_FILENAME" "s3://robert-consulting-website/blog-posts/" --debug
          
          echo "‚úÖ Successfully uploaded to S3: $BLOG_FILENAME"
          
      - name: Invalidate CloudFront
        if: steps.generate-content.outputs.blog-generated == 'true'
        run: |
          aws cloudfront create-invalidation --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID }} --paths "/blog-posts/*"
          echo "üîÑ CloudFront cache invalidated"
          
      - name: Commit and push changes
        if: steps.generate-content.outputs.blog-generated == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add .
          # Skip pre-commit hook for automated blog commits (hooks may fail in CI environment)
          git commit --no-verify -m "üìù Auto-generated blog post for ${{ steps.blog-day.outputs.day }}"
          git push origin main
          echo "‚úÖ Changes committed and pushed"