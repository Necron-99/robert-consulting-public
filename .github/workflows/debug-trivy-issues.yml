name: ğŸ” Debug Trivy Issues

on:
  workflow_dispatch:
  push:
    branches: [main]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  debug-alerts:
    name: ğŸ” Debug Code Scanning Alerts
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: read

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v5

      - name: ğŸ“¦ Install CLI dependencies (gh, jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: ğŸ” Get Alerts and Debug Structure
        run: |
          echo "ğŸ” Fetching Code Scanning alerts..."
          gh api repos/${{ github.repository }}/code-scanning/alerts --jq '.[] | select(.state == "open")' > alerts.json
          echo "ğŸ“Š Found $(jq -s length alerts.json) alerts"
          
          echo "ğŸ” First alert structure:"
          jq -s '.[0]' alerts.json
          
          echo "ğŸ” Available fields:"
          jq -s '.[0] | keys' alerts.json
          
          echo "ğŸ” Rule structure:"
          jq -s '.[0].rule' alerts.json
          
          echo "ğŸ” Tool structure:"
          jq -s '.[0].tool' alerts.json
