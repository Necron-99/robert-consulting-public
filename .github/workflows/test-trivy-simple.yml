name: ðŸ§ª Test Trivy Simple

on:
  workflow_dispatch:
  push:
    branches: [main]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  test-simple:
    name: ðŸ§ª Test Simple Processing
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: read
      issues: write

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v5

      - name: ðŸ“¦ Install CLI dependencies (gh, jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: ðŸ” Get Alerts
        run: |
          gh api repos/${{ github.repository }}/code-scanning/alerts --jq '.[] | select(.state == "open")' > alerts.json || echo "[]" > alerts.json
          
          if [ -f "alerts.json" ] && jq empty alerts.json 2>/dev/null; then
            echo "Found $(jq -s 'if type == "array" then length else 0 end' alerts.json) alerts"
          else
            echo "Found 0 alerts"
          fi

      - name: ðŸŽ¯ Test Processing
        run: |
          echo "Testing jq processing..."
          
          # Test 1: Show all alerts
          echo "=== All Alerts ==="
          jq -s '.[] | {rule_name: .rule.name, severity: .rule.security_severity_level, tool: .tool.name}' alerts.json
          
          # Test 2: Filter for high/critical
          echo "=== High/Critical Alerts ==="
          jq -s '.[] | select(.rule.security_severity_level == "critical" or .rule.security_severity_level == "high") | {rule_name: .rule.name, severity: .rule.security_severity_level, tool: .tool.name}' alerts.json > test-findings.json
          
          if [ -f "test-findings.json" ] && jq empty test-findings.json 2>/dev/null; then
            echo "Found $(jq 'if type == "array" then length else 0 end' test-findings.json) high/critical findings"
          else
            echo "Found 0 high/critical findings"
          fi
          
          if [ -f "test-findings.json" ] && jq empty test-findings.json 2>/dev/null && [ "$(jq 'if type == "array" then length else 0 end' test-findings.json)" -gt 0 ]; then
            echo "=== First Finding ==="
            jq '.[0]' test-findings.json
          else
            echo "No high/critical findings found"
          fi

      - name: ðŸ¤– Test Issue Creation
        run: |
          set -e
          if [ -f "test-findings.json" ] && jq empty test-findings.json 2>/dev/null && [ "$(jq 'if type == "array" then length else 0 end' test-findings.json)" -gt 0 ]; then
            echo "Testing issue creation..."
            first_finding=$(jq '.[0]' test-findings.json)
            rule_name=$(echo "$first_finding" | jq -r '.rule_name')
            severity=$(echo "$first_finding" | jq -r '.severity')
            tool=$(echo "$first_finding" | jq -r '.tool')
            
            echo "Would create issue for: $rule_name ($severity) from $tool"
            
            # Check if issue already exists
            existing=$(gh issue list --search "in:title \"$rule_name\"" --state open --json number --jq '.[0].number // empty')
            
            if [ -z "$existing" ]; then
              echo "Creating test issue..."
              body_text="This is a test issue created by the Trivy Issue Creator workflow.

**Severity:** $severity
**Tool:** $tool
**Rule:** $rule_name

This is a test to verify the workflow is working correctly."
              
              gh issue create \
                --title "ðŸ§ª TEST: $severity: $rule_name" \
                --body "$body_text" \
                --label "test,security,$severity,$tool,automated" || echo "Failed to create test issue"
            else
              echo "Test issue already exists: #$existing"
            fi
          else
            echo "No findings to create issues for"
          fi
