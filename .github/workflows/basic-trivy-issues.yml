name: ðŸ”’ Basic Trivy Issues

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
  push:
    branches: [main]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  create-issues:
    name: ðŸ” Create Issues from Trivy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: read
      issues: write

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v5

      - name: ðŸ“¦ Install CLI dependencies (gh, jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: ðŸ” Get Alerts
        run: |
          # Get alerts and ensure valid JSON output
          gh api repos/${{ github.repository }}/code-scanning/alerts > all-alerts.json || echo "[]" > all-alerts.json
          
          # Filter for open alerts and ensure valid JSON array
          if [ -f "all-alerts.json" ] && [ -s "all-alerts.json" ]; then
            # Filter for open alerts and wrap in array
            jq '[.[] | select(.state == "open")]' all-alerts.json > alerts.json || echo "[]" > alerts.json
          else
            echo "[]" > alerts.json
          fi
          
          # Validate alerts.json is valid JSON
          if ! jq empty alerts.json 2>/dev/null; then
            echo "âš ï¸ alerts.json is invalid, creating empty array"
            echo "[]" > alerts.json
          fi
          
          alert_count=$(jq 'length' alerts.json || echo "0")
          echo "Found $alert_count alerts"
          
          # Clean up
          rm -f all-alerts.json

      - name: ðŸŽ¯ Process Findings
        run: |
          # Process alerts and create findings.json, defaulting to empty array if no results
          if [ -f "alerts.json" ] && [ -s "alerts.json" ]; then
            # Validate alerts.json is valid JSON before processing
            if jq empty alerts.json 2>/dev/null; then
              jq '
                if length > 0 then
                  group_by(.rule.name) | 
                  map(select(.[0].rule.security_severity_level == "critical" or .[0].rule.security_severity_level == "high")) |
                  map({
                    rule_name: .[0].rule.name,
                    severity: .[0].rule.security_severity_level,
                    count: length,
                    tool: .[0].tool.name
                  })
                else
                  []
                end
              ' alerts.json > findings.json || echo "[]" > findings.json
            else
              echo "âš ï¸ alerts.json is invalid JSON, creating empty findings"
              echo "[]" > findings.json
            fi
          else
            echo "[]" > findings.json
          fi
          
          # Validate findings.json is valid JSON
          if ! jq empty findings.json 2>/dev/null; then
            echo "âš ï¸ findings.json is invalid, creating empty array"
            echo "[]" > findings.json
          fi
          
          finding_count=$(jq 'length' findings.json || echo "0")
          echo "Found $finding_count unique findings"

      - name: ðŸ¤– Create Issues
        run: |
          set -e
          # Validate findings.json exists and is valid JSON
          if [ ! -f "findings.json" ]; then
            echo "âš ï¸ findings.json does not exist, creating empty array"
            echo "[]" > findings.json
          fi
          
          # Validate JSON before processing
          if ! jq empty findings.json 2>/dev/null; then
            echo "âš ï¸ findings.json is invalid JSON, creating empty array"
            echo "[]" > findings.json
          fi
          
          if [ -f "findings.json" ] && [ -s "findings.json" ]; then
            finding_count=$(jq 'length' findings.json 2>/dev/null || echo "0")
            # Convert to integer for comparison (handle case where finding_count might be empty)
            finding_count_int=${finding_count:-0}
            if [ "$finding_count_int" -gt 0 ]; then
            jq -r '.[]' findings.json 2>/dev/null | while IFS= read -r finding || [ -n "$finding" ]; do
              if [ -z "$finding" ]; then
                continue
              fi
              rule_name=$(echo "$finding" | jq -r '.rule_name // empty' 2>/dev/null)
              severity=$(echo "$finding" | jq -r '.severity // empty' 2>/dev/null)
              count=$(echo "$finding" | jq -r '.count // empty' 2>/dev/null)
              tool=$(echo "$finding" | jq -r '.tool // empty' 2>/dev/null)
              
              # Skip if any required field is empty
              if [ -z "$rule_name" ] || [ -z "$severity" ]; then
                echo "âš ï¸ Skipping invalid finding entry"
                continue
              fi
              
              existing=$(gh issue list --search "in:title \"$rule_name\"" --state open --json number --jq '.[0].number // empty')
              
              if [ -z "$existing" ]; then
                echo "Creating issue for: $rule_name ($severity)"
                gh issue create --title "ðŸ”’ $severity: $rule_name" --body "Severity: $severity\nTool: $tool\nOccurrences: $count\n\nAuto-created from Code Scanning alerts" --label "security,$severity,$tool,automated" || echo "Failed to create issue"
              else
                echo "Issue already exists for $rule_name (#$existing)"
              fi
            done
            else
              echo "No high/critical findings to process"
            fi
          else
            echo "No findings.json file or file is empty"
          fi

      - name: ðŸ“Š Summary
        run: |
          echo "Summary:"
          if [ -f "findings.json" ] && [ -s "findings.json" ]; then
            total=$(jq 'length' findings.json || echo "0")
            critical=$(jq '[.[] | select(.severity == "critical")] | length' findings.json || echo "0")
            high=$(jq '[.[] | select(.severity == "high")] | length' findings.json || echo "0")
            echo "Total findings: $total"
            echo "Critical: $critical"
            echo "High: $high"
          else
            echo "Total findings: 0"
            echo "Critical: 0"
            echo "High: 0"
          fi
          open_issues=$(gh issue list --label "security" --state open --json number 2>/dev/null | jq 'length' || echo "0")
          echo "Open security issues: $open_issues"
