name: ðŸ”’ Basic Trivy Issues

on:
  schedule:
    - cron: '0 */6 * * *'
  workflow_dispatch:
  push:
    branches: [main]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  create-issues:
    name: ðŸ” Create Issues from Trivy
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: read
      issues: write

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v5

      - name: ðŸ“¦ Install CLI dependencies (gh, jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: ðŸ” Get Alerts
        run: |
          gh api repos/${{ github.repository }}/code-scanning/alerts --jq '.[] | select(.state == "open")' > alerts.json || true
          # Check if alerts.json exists and has valid content
          if [ -f "alerts.json" ] && [ -s "alerts.json" ]; then
            alert_count=$(jq -s 'length' alerts.json || echo "0")
            echo "Found $alert_count alerts"
          else
            echo "[]" > alerts.json
            echo "Found 0 alerts"
          fi

      - name: ðŸŽ¯ Process Findings
        run: |
          # Process alerts and create findings.json, defaulting to empty array if no results
          if [ -f "alerts.json" ] && [ -s "alerts.json" ]; then
            jq -s '
              if length > 0 then
                group_by(.rule.name) | 
                map(select(.[0].rule.security_severity_level == "critical" or .[0].rule.security_severity_level == "high")) |
                map({
                  rule_name: .[0].rule.name,
                  severity: .[0].rule.security_severity_level,
                  count: length,
                  tool: .[0].tool.name
                })
              else
                []
              end
            ' alerts.json > findings.json
          else
            echo "[]" > findings.json
          fi
          
          finding_count=$(jq 'length' findings.json || echo "0")
          echo "Found $finding_count unique findings"

      - name: ðŸ¤– Create Issues
        run: |
          set -e
          if [ -f "findings.json" ] && [ -s "findings.json" ]; then
            finding_count=$(jq 'length' findings.json || echo "0")
            if [ "$finding_count" -gt 0 ]; then
            jq -r '.[]' findings.json | while read -r finding; do
              rule_name=$(echo "$finding" | jq -r '.rule_name')
              severity=$(echo "$finding" | jq -r '.severity')
              count=$(echo "$finding" | jq -r '.count')
              tool=$(echo "$finding" | jq -r '.tool')
              
              existing=$(gh issue list --search "in:title \"$rule_name\"" --state open --json number --jq '.[0].number // empty')
              
              if [ -z "$existing" ]; then
                echo "Creating issue for: $rule_name ($severity)"
                gh issue create --title "ðŸ”’ $severity: $rule_name" --body "Severity: $severity\nTool: $tool\nOccurrences: $count\n\nAuto-created from Code Scanning alerts" --label "security,$severity,$tool,automated" || echo "Failed to create issue"
              else
                echo "Issue already exists for $rule_name (#$existing)"
              fi
            done
            else
              echo "No high/critical findings to process"
            fi
          else
            echo "No findings.json file or file is empty"
          fi

      - name: ðŸ“Š Summary
        run: |
          echo "Summary:"
          if [ -f "findings.json" ] && [ -s "findings.json" ]; then
            total=$(jq 'length' findings.json || echo "0")
            critical=$(jq '[.[] | select(.severity == "critical")] | length' findings.json || echo "0")
            high=$(jq '[.[] | select(.severity == "high")] | length' findings.json || echo "0")
            echo "Total findings: $total"
            echo "Critical: $critical"
            echo "High: $high"
          else
            echo "Total findings: 0"
            echo "Critical: 0"
            echo "High: 0"
          fi
          open_issues=$(gh issue list --label "security" --state open --json number 2>/dev/null | jq 'length' || echo "0")
          echo "Open security issues: $open_issues"
