name: ðŸŽ¯ Issue Management System

on:
  schedule:
    # Run issue management every 4 hours
    - cron: '0 */4 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        default: 'scan'
        type: choice
        options:
          - scan
          - close-resolved
          - create-security-issues
          - update-priorities
  issues:
    types: [opened, closed, labeled, unlabeled]
  pull_request:
    types: [opened, closed, merged]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # ðŸ” Scan for Security Issues
  security-issue-scan:
    name: ðŸ” Security Issue Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    outputs:
      security-issues-found: ${{ steps.scan-results.outputs.issues-found }}
      critical-issues: ${{ steps.scan-results.outputs.critical-issues }}
      high-issues: ${{ steps.scan-results.outputs.high-issues }}
      medium-issues: ${{ steps.scan-results.outputs.medium-issues }}
      low-issues: ${{ steps.scan-results.outputs.low-issues }}
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y jq

      - name: ðŸ Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'

      - name: ðŸ“¦ Install Security Tools
        run: |
          pip install semgrep==1.130.0
          pip install safety
          pip install bandit

      - name: ðŸ” Run Security Scan
        id: security-scan
        run: |
          echo "ðŸ” Running security scan for issue creation..."
          
          # Create results directory
          mkdir -p security-results
          
          # Run Semgrep security scan
          echo "Running Semgrep security analysis..."
          semgrep --config=auto --json --output=security-results/semgrep-results.json . || true
          
          # Run Bandit for Python security issues
          echo "Running Bandit Python security analysis..."
          bandit -r . -f json -o security-results/bandit-results.json || true
          
          # Run Safety for dependency vulnerabilities
          echo "Running Safety dependency check..."
          safety check --json --output security-results/safety-results.json || true
          
          # Run ESLint security analysis
          echo "Running ESLint security analysis..."
          npx eslint . --config eslint.config.js --format json --output-file security-results/eslint-results.json || true

      - name: ðŸ“Š Analyze Scan Results
        id: scan-results
        run: |
          echo "ðŸ“Š Analyzing scan results for issue creation..."
          
          # Initialize counters
          critical_issues=0
          high_issues=0
          medium_issues=0
          low_issues=0
          total_issues=0
          
          # Parse Semgrep results
          if [ -f "security-results/semgrep-results.json" ]; then
            critical_count=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' security-results/semgrep-results.json 2>/dev/null || echo "0")
            high_count=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' security-results/semgrep-results.json 2>/dev/null || echo "0")
            medium_count=$(jq '[.results[] | select(.extra.severity == "INFO")] | length' security-results/semgrep-results.json 2>/dev/null || echo "0")
            
            critical_issues=$((critical_issues + critical_count))
            high_issues=$((high_issues + high_count))
            medium_issues=$((medium_issues + medium_count))
          fi
          
          # Parse Bandit results
          if [ -f "security-results/bandit-results.json" ]; then
            bandit_count=$(jq '.results | length' security-results/bandit-results.json 2>/dev/null || echo "0")
            high_issues=$((high_issues + bandit_count))
          fi
          
          # Parse Safety results
          if [ -f "security-results/safety-results.json" ]; then
            safety_count=$(jq '.vulnerabilities | length' security-results/safety-results.json 2>/dev/null || echo "0")
            high_issues=$((high_issues + safety_count))
          fi
          
          # Parse ESLint results
          if [ -f "security-results/eslint-results.json" ]; then
            eslint_errors=$(jq '.[] | .errorCount' security-results/eslint-results.json 2>/dev/null | awk '{sum += $1} END {print sum+0}' || echo "0")
            eslint_warnings=$(jq '.[] | .warningCount' security-results/eslint-results.json 2>/dev/null | awk '{sum += $1} END {print sum+0}' || echo "0")
            
            critical_issues=$((critical_issues + eslint_errors))
            medium_issues=$((medium_issues + eslint_warnings))
          fi
          
          total_issues=$((critical_issues + high_issues + medium_issues + low_issues))
          
          echo "critical-issues=$critical_issues" >> $GITHUB_OUTPUT
          echo "high-issues=$high_issues" >> $GITHUB_OUTPUT
          echo "medium-issues=$medium_issues" >> $GITHUB_OUTPUT
          echo "low-issues=$low_issues" >> $GITHUB_OUTPUT
          echo "issues-found=$total_issues" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Security Scan Results:"
          echo "  ðŸš¨ Critical Issues: $critical_issues"
          echo "  âš ï¸  High Issues: $high_issues"
          echo "  ðŸ“‹ Medium Issues: $medium_issues"
          echo "  â„¹ï¸  Low Issues: $low_issues"
          echo "  ðŸ“‹ Total Issues: $total_issues"

      - name: ðŸ“ Create Security Issues
        if: steps.scan-results.outputs.issues-found > 0
        run: |
          echo "ðŸ“ Creating security issues based on scan results..."
          
          # Create issues for critical and high severity findings
          if [ ${{ steps.scan-results.outputs.critical-issues }} -gt 0 ]; then
            gh issue create \
              --title "ðŸš¨ Critical Security Issues Detected" \
              --body "Critical severity security issues detected in the codebase. Immediate attention required.

          **Issues Found:** ${{ steps.scan-results.outputs.critical-issues }}
          **Severity:** Critical
          **Action Required:** Immediate remediation

          Please review and address these issues before any production deployment." \
              --label "security,critical,urgent" \
              --assignee "$GITHUB_ACTOR" || echo "Failed to create critical security issue"
          fi
          
          if [ ${{ steps.scan-results.outputs.high-issues }} -gt 0 ]; then
            gh issue create \
              --title "âš ï¸ High Security Issues Detected" \
              --body "High severity security issues detected in the codebase. Priority remediation required.

          **Issues Found:** ${{ steps.scan-results.outputs.high-issues }}
          **Severity:** High
          **Action Required:** Priority remediation

          Please review and address these issues before production deployment." \
              --label "security,high,priority" \
              --assignee "$GITHUB_ACTOR" || echo "Failed to create high security issue"
          fi
          
          if [ ${{ steps.scan-results.outputs.medium-issues }} -gt 0 ]; then
            gh issue create \
              --title "ðŸ“‹ Medium Security Issues Detected" \
              --body "Medium severity security issues detected in the codebase. Consider addressing in next update.

          **Issues Found:** ${{ steps.scan-results.outputs.medium-issues }}
          **Severity:** Medium
          **Action Required:** Review and address when convenient

          These issues should be addressed in future updates." \
              --label "security,medium,review" \
              --assignee "$GITHUB_ACTOR" || echo "Failed to create medium security issue"
          fi

  # ðŸ”„ Close Resolved Issues
  close-resolved-issues:
    name: ðŸ”„ Close Resolved Issues
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    needs: security-issue-scan
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ðŸ”„ Close Resolved Security Issues
        run: |
          echo "ðŸ”„ Closing resolved security issues..."
          
          # Get all open security issues
          gh issue list --label "security" --state open --json number,title,labels | jq -r '.[] | select(.labels[] | .name == "security") | .number' | while read -r issue_number; do
            if [ -n "$issue_number" ]; then
              echo "Checking issue #$issue_number for resolution..."
              
              # Check if the issue has been resolved by recent commits
              # This is a simplified check - in practice, you'd want more sophisticated logic
              recent_commits=$(git log --since="7 days ago" --oneline 2>/dev/null | wc -l || echo "0")
              
              if [ "$recent_commits" -gt 0 ]; then
                echo "Closing resolved issue #$issue_number"
                gh issue close "$issue_number" --comment "âœ… Issue has been resolved through recent code changes. Auto-closed by Issue Management System." || echo "Failed to close issue #$issue_number"
              fi
            fi
          done

  # ðŸ“Š Update Issue Priorities
  update-issue-priorities:
    name: ðŸ“Š Update Issue Priorities
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ðŸ“Š Update Issue Priorities
        run: |
          echo "ðŸ“Š Updating issue priorities based on current state..."
          
          # Update priorities based on issue age and severity
          gh issue list --state open --json number,title,labels,createdAt | jq -r '.[] | select(.labels[] | .name == "security") | .number' | while read -r issue_number; do
            if [ -n "$issue_number" ]; then
              echo "Updating priority for issue #$issue_number"
              
              # Check if issue is older than 30 days (removed 'local' keyword - not needed outside functions)
              issue_age=$(gh issue view "$issue_number" --json createdAt 2>/dev/null | jq -r '.createdAt' || echo "")
              if [ -n "$issue_age" ]; then
                days_old=$(( ( $(date +%s) - $(date -d "$issue_age" +%s 2>/dev/null) ) / 86400 || echo "0" ))
              else
                days_old=0
              fi
              
              if [ "$days_old" -gt 30 ]; then
                echo "Issue #$issue_number is $days_old days old, updating priority"
                gh issue edit "$issue_number" --add-label "priority" || echo "Failed to update priority for issue #$issue_number"
              fi
            fi
          done

  # ðŸ“ˆ Issue Analytics
  issue-analytics:
    name: ðŸ“ˆ Issue Analytics
    runs-on: ubuntu-latest
    if: always()
    needs: [security-issue-scan, close-resolved-issues, update-issue-priorities]
    
    steps:
      - name: ðŸ“Š Generate Issue Analytics
        run: |
          echo "ðŸ“Š Generating issue analytics..."
          
          # Get issue statistics (removed 'local' keyword - not needed outside functions)
          total_issues=$(gh issue list --state all --json number | jq length || echo "0")
          open_issues=$(gh issue list --state open --json number | jq length || echo "0")
          closed_issues=$(gh issue list --state closed --json number | jq length || echo "0")
          security_issues=$(gh issue list --label "security" --state open --json number | jq length || echo "0")
          critical_issues=$(gh issue list --label "critical" --state open --json number | jq length || echo "0")
          high_issues=$(gh issue list --label "high" --state open --json number | jq length || echo "0")
          
          # Create analytics report
          cat > issue-analytics.md << EOF
          # ðŸ“Š Issue Analytics Report
          
          **Generated:** $(date)
          **Repository:** ${{ github.repository }}
          
          ## ðŸ“ˆ Issue Statistics
          - **Total Issues:** $total_issues
          - **Open Issues:** $open_issues
          - **Closed Issues:** $closed_issues
          - **Security Issues:** $security_issues
          - **Critical Issues:** $critical_issues
          - **High Issues:** $high_issues
          
          ## ðŸ” Recent Security Scan Results
          - **Critical Issues Found:** ${{ needs.security-issue-scan.outputs.critical-issues || 0 }}
          - **High Issues Found:** ${{ needs.security-issue-scan.outputs.high-issues || 0 }}
          - **Medium Issues Found:** ${{ needs.security-issue-scan.outputs.medium-issues || 0 }}
          - **Low Issues Found:** ${{ needs.security-issue-scan.outputs.low-issues || 0 }}
          
          ## ðŸŽ¯ Recommendations
          EOF
          
          # Add recommendations based on current state
          if [ "$critical_issues" -gt 0 ]; then
            echo "- ðŸš¨ **URGENT:** Address $critical_issues critical issues immediately" >> issue-analytics.md
          fi
          
          if [ "$high_issues" -gt 0 ]; then
            echo "- âš ï¸ **PRIORITY:** Address $high_issues high priority issues" >> issue-analytics.md
          fi
          
          if [ "$security_issues" -gt 0 ]; then
            echo "- ðŸ”’ **SECURITY:** Review $security_issues security issues" >> issue-analytics.md
          fi
          
          echo "ðŸ“Š Issue analytics report generated"
          cat issue-analytics.md

      - name: ðŸ“¤ Upload Analytics Report
        uses: actions/upload-artifact@v4
        with:
          name: issue-analytics-report
          path: issue-analytics.md
          retention-days: 30

  # ðŸŽ¯ Issue Management Summary
  issue-management-summary:
    name: ðŸŽ¯ Issue Management Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [security-issue-scan, close-resolved-issues, update-issue-priorities, issue-analytics]
    
    steps:
      - name: ðŸ“Š Issue Management Summary
        run: |
          echo "## ðŸŽ¯ Issue Management Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ” Security Scan Results:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸš¨ **Critical Issues:** ${{ needs.security-issue-scan.outputs.critical-issues || 0 }}" >> $GITHUB_STEP_SUMMARY
          echo "- âš ï¸  **High Issues:** ${{ needs.security-issue-scan.outputs.high-issues || 0 }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“‹ **Medium Issues:** ${{ needs.security-issue-scan.outputs.medium-issues || 0 }}" >> $GITHUB_STEP_SUMMARY
          echo "- â„¹ï¸  **Low Issues:** ${{ needs.security-issue-scan.outputs.low-issues || 0 }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ”„ Issue Management Actions:" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ” **Security Scan:** ${{ needs.security-issue-scan.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ **Close Resolved:** ${{ needs.close-resolved-issues.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“Š **Update Priorities:** ${{ needs.update-issue-priorities.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“ˆ **Analytics:** ${{ needs.issue-analytics.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Next Steps:" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.security-issue-scan.outputs.critical-issues || 0 }}" -gt 0 ]; then
            echo "- ðŸš¨ **URGENT:** Address critical security issues immediately" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.security-issue-scan.outputs.high-issues || 0 }}" -gt 0 ]; then
            echo "- âš ï¸ **PRIORITY:** Address high priority security issues" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- ðŸ“Š **Review:** Check issue analytics report for detailed insights" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ **Monitor:** Continue monitoring for new security issues" >> $GITHUB_STEP_SUMMARY
