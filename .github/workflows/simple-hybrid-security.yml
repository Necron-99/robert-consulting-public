name: ğŸ”„ Simple Hybrid Security Management

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      severity_filter:
        description: 'Minimum severity to process'
        required: true
        default: 'high'
        type: choice
        options:
          - critical
          - high
          - medium
          - low
  push:
    branches: [main, staging]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  # Monitor Code Scanning alerts and create Issues for critical/high findings
  code-scanning-monitor:
    name: ğŸ” Monitor Code Scanning Alerts
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: read
      issues: write
      pull-requests: read

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ğŸ” Get Code Scanning Alerts
        id: get-alerts
        run: |
          echo "ğŸ” Fetching Code Scanning alerts..."
          
          # Get code scanning results (SARIF uploads)
          gh api repos/${{ github.repository }}/code-scanning/alerts --jq '.[] | select(.state == "open")' > sarif-alerts.json || echo "[]" > sarif-alerts.json
          
          if [ -f "sarif-alerts.json" ] && jq empty sarif-alerts.json 2>/dev/null; then
            echo "ğŸ“Š Found $(jq 'if type == "array" then length else 0 end' sarif-alerts.json) SARIF alerts"
          else
            echo "ğŸ“Š Found 0 SARIF alerts"
          fi

      - name: ğŸ¯ Process Critical/High Findings
        id: process-findings
        run: |
          echo "ğŸ¯ Processing critical and high severity findings..."
          
          # Set minimum severity (default: high)
          MIN_SEVERITY="${{ github.event.inputs.severity_filter || 'high' }}"
          
          # Process SARIF alerts (Trivy, Semgrep, etc.)
          if [ -f "sarif-alerts.json" ] && jq empty sarif-alerts.json 2>/dev/null && [ "$(jq 'if type == "array" then length else 0 end' sarif-alerts.json)" -gt 0 ]; then
            echo "ğŸ” Processing SARIF alerts..."
            
            # Filter for critical/high severity and group by rule
            jq -r --arg min_severity "$MIN_SEVERITY" '
              group_by(.rule.name) | 
              map(select(.[0].rule.severity as $sev | 
                ($sev == "CRITICAL" or $sev == "ERROR") or 
                ($min_severity == "high" and $sev == "WARNING") or
                ($min_severity == "medium" and ($sev == "WARNING" or $sev == "NOTE")) or
                ($min_severity == "low")
              )) |
              .[] | 
              {
                rule_name: .[0].rule.name,
                severity: .[0].rule.severity,
                count: length,
                files: [.[] | .most_recent_instance.location.physical_location.artifact_location.uri] | unique,
                first_seen: (.[] | .created_at) | min,
                last_seen: (.[] | .created_at) | max,
                tool: .[0].tool.name,
                description: .[0].rule.description
              }
            ' sarif-alerts.json > processed-findings.json
            
            if [ -f "processed-findings.json" ] && jq empty processed-findings.json 2>/dev/null; then
              echo "ğŸ“Š Processed $(jq 'if type == "array" then length else 0 end' processed-findings.json) unique findings"
            else
              echo "ğŸ“Š Processed 0 unique findings"
            fi
          fi

      - name: ğŸ¤– Create Issues for Critical/High Findings
        run: |
          echo "ğŸ¤– Creating Issues for critical/high findings..."
          
          if [ -f "processed-findings.json" ] && jq empty processed-findings.json 2>/dev/null && [ "$(jq 'if type == "array" then length else 0 end' processed-findings.json)" -gt 0 ]; then
            jq -r '.[]' processed-findings.json | while read -r finding; do
              rule_name=$(echo "$finding" | jq -r '.rule_name')
              severity=$(echo "$finding" | jq -r '.severity')
              count=$(echo "$finding" | jq -r '.count')
              tool=$(echo "$finding" | jq -r '.tool')
              description=$(echo "$finding" | jq -r '.description')
              files=$(echo "$finding" | jq -r '.files | join(", ")')
              
              # Check if issue already exists for this rule
              existing_issue=$(gh issue list --search "in:title \"$rule_name\"" --state open --json number --jq '.[0].number // empty')
              
              if [ -z "$existing_issue" ]; then
                echo "ğŸ“ Creating issue for: $rule_name ($severity)"
                
                # Create simple issue body
                issue_title="ğŸ”’ $severity: $rule_name"
                issue_body="**Rule:** \`$rule_name\`
**Severity:** \`$severity\`
**Tool:** $tool
**Occurrences:** $count
**Files Affected:** $files

**Description:**
$description

**Remediation Steps:**
- [ ] Review the affected files
- [ ] Implement recommended security fixes
- [ ] Test changes in staging environment
- [ ] Deploy to production after validation

---
*This issue was automatically created from Code Scanning alerts by the Hybrid Security Management System*"
                
                # Create the issue
                gh issue create \
                  --title "$issue_title" \
                  --body "$issue_body" \
                  --label "security,$severity,$tool,automated" \
                  --assignee "$GITHUB_ACTOR" || echo "âš ï¸ Failed to create issue for $rule_name"
              else
                echo "â„¹ï¸ Issue already exists for $rule_name (#$existing_issue)"
              fi
            done
          fi

      - name: ğŸ“Š Generate Security Summary
        run: |
          echo "ğŸ“Š Security Management Summary:"
          echo "================================"
          
          if [ -f "processed-findings.json" ] && jq empty processed-findings.json 2>/dev/null; then
            total_findings=$(jq 'if type == "array" then length else 0 end' processed-findings.json)
            critical_findings=$(jq 'if type == "array" then [.[] | select(.severity == "CRITICAL" or .severity == "ERROR")] | length else 0 end' processed-findings.json)
            high_findings=$(jq 'if type == "array" then [.[] | select(.severity == "WARNING")] | length else 0 end' processed-findings.json)
            
            echo "ğŸ” Total Unique Findings: $total_findings"
            echo "ğŸš¨ Critical/Error Findings: $critical_findings"
            echo "âš ï¸ High/Warning Findings: $high_findings"
            echo ""
            echo "ğŸ“‹ Findings by Tool:"
            jq -r 'group_by(.tool) | .[] | "- \(.[0].tool): \(length) findings"' processed-findings.json
          fi
          
          echo ""
          echo "ğŸ“ˆ Open Security Issues:"
          gh issue list --label "security" --state open --json number,title,labels | jq -r '.[] | "- #\(.number): \(.title)"'
