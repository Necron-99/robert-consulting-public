name: ðŸ”’ Trivy Issue Creator

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch:
  push:
    branches: [main, staging]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  create-issues-from-trivy:
    name: ðŸ” Create Issues from Trivy Findings
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: read
      issues: write

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ðŸ“¦ Install CLI dependencies (gh, jq)
        run: |
          sudo apt-get update
          sudo apt-get install -y gh jq

      - name: ðŸ” Get Code Scanning Alerts
        run: |
          echo "ðŸ” Fetching Code Scanning alerts..."
          gh api repos/${{ github.repository }}/code-scanning/alerts --jq '.[] | select(.state == "open")' > alerts.json || echo "[]" > alerts.json
          
          if [ -f "alerts.json" ] && jq empty alerts.json 2>/dev/null; then
            echo "ðŸ“Š Found $(jq 'if type == "array" then length else 0 end' alerts.json) open alerts"
          else
            echo "ðŸ“Š Found 0 open alerts"
          fi

      - name: ðŸŽ¯ Process High/Critical Findings
        run: |
          echo "ðŸŽ¯ Processing high and critical findings..."
          
          # Group alerts by rule and filter for high/critical using security_severity_level
          jq -r '
            group_by(.rule.name) |
            map(select(.[0].rule.security_severity_level == "critical" or .[0].rule.security_severity_level == "high")) |
            .[] |
            {
              rule_name: .[0].rule.name,
              severity: .[0].rule.security_severity_level,
              count: length,
              tool: .[0].tool.name,
              description: .[0].rule.description
            }
          ' alerts.json > findings.json
          
          if [ -f "findings.json" ] && jq empty findings.json 2>/dev/null; then
            echo "ðŸ“Š Found $(jq 'if type == "array" then length else 0 end' findings.json) unique high/critical findings"
          else
            echo "ðŸ“Š Found 0 unique high/critical findings"
          fi

      - name: ðŸ¤– Create Issues
        run: |
          echo "ðŸ¤– Creating Issues for findings..."
          set -e
          
          if [ -f "findings.json" ] && jq empty findings.json 2>/dev/null && [ "$(jq 'if type == "array" then length else 0 end' findings.json)" -gt 0 ]; then
            jq -r '.[]' findings.json | while read -r finding; do
              rule_name=$(echo "$finding" | jq -r '.rule_name')
              severity=$(echo "$finding" | jq -r '.severity')
              count=$(echo "$finding" | jq -r '.count')
              tool=$(echo "$finding" | jq -r '.tool')
              description=$(echo "$finding" | jq -r '.description')
              
              # Check if issue already exists
              existing=$(gh issue list --search "in:title \"$rule_name\"" --state open --json number --jq '.[0].number // empty')
              
              if [ -z "$existing" ]; then
                echo "ðŸ“ Creating issue for: $rule_name ($severity)"
                
                # Create issue with simple body
                body_text="**Severity:** $severity
**Tool:** $tool
**Occurrences:** $count

**Description:**
$description

**Action Required:**
- [ ] Review and fix security issue
- [ ] Test changes in staging
- [ ] Deploy to production

*Auto-created from Code Scanning alerts*"
                
                gh issue create \
                  --title "ðŸ”’ $severity: $rule_name" \
                  --body "$body_text" \
                  --label "security,$severity,$tool,automated" || echo "Failed to create issue for $rule_name"
              else
                echo "â„¹ï¸ Issue already exists for $rule_name (#$existing)"
              fi
            done
          fi

      - name: ðŸ“Š Summary
        run: |
          echo "ðŸ“Š Summary:"
          echo "==========="
          if [ -f "findings.json" ] && jq empty findings.json 2>/dev/null; then
            echo "ðŸ” Total findings: $(jq 'if type == "array" then length else 0 end' findings.json)"
            echo "ðŸš¨ Critical: $(jq 'if type == "array" then [.[] | select(.severity == "CRITICAL" or .severity == "ERROR")] | length else 0 end' findings.json)"
            echo "âš ï¸ High: $(jq 'if type == "array" then [.[] | select(.severity == "WARNING")] | length else 0 end' findings.json)"
          else
            echo "ðŸ” Total findings: 0"
            echo "ðŸš¨ Critical: 0"
            echo "âš ï¸ High: 0"
          fi
          security_issues=$(gh issue list --label "security" --state open --json number 2>/dev/null | jq 'if type == "array" then length else 0 end' || echo "0")
          echo "ðŸ“ˆ Open security issues: $security_issues"
