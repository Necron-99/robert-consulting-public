name: Test Staging Access

on:
  workflow_dispatch:
  push:
    branches: [ staging ]
    paths:
      - '.github/workflows/test-staging-access.yml'

jobs:
  test-staging-access:
    name: 🧪 Test Staging Site Access
    runs-on: ubuntu-latest
    steps:
      - name: 📥 Checkout code
        uses: actions/checkout@v4

      - name: 🔍 Test staging site accessibility
        run: |
          echo "Testing staging site access from GitHub Actions..."
          
          # Get the current IP address
          CURRENT_IP=$(curl -s https://ipinfo.io/ip)
          echo "Current GitHub Actions runner IP: $CURRENT_IP"
          
          # Test basic connectivity
          if curl -f -s -I "${{ env.STAGING_URL }}" > /dev/null; then
            echo "✅ Staging site is accessible from GitHub Actions"
            curl -s -I "${{ env.STAGING_URL }}" | head -10
          else
            echo "❌ Staging site is not accessible from GitHub Actions"
            echo "Current IP: $CURRENT_IP"
            echo "This IP needs to be added to the staging allowlist"
            exit 1
          fi

      - name: 🔍 Test staging site content
        run: |
          echo "Testing staging site content..."
          
          # Test that we can get the actual content
          CONTENT=$(curl -s "${{ env.STAGING_URL }}")
          if echo "$CONTENT" | grep -q "Robert Consulting"; then
            echo "✅ Staging site content is accessible"
          else
            echo "❌ Staging site content is not accessible"
            exit 1
          fi

      - name: 📊 Test Results Summary
        run: |
          echo "## 🧪 Staging Access Test Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: ✅ Staging site is accessible from GitHub Actions" >> $GITHUB_STEP_SUMMARY
          echo "- **IP Restrictions**: Working correctly - GitHub Actions IPs are allowed" >> $GITHUB_STEP_SUMMARY
          echo "- **Test Time**: $(date -u)" >> $GITHUB_STEP_SUMMARY

env:
  STAGING_URL: 'https://staging.robertconsulting.net'
# Trigger test workflow
# Test final IP restriction
