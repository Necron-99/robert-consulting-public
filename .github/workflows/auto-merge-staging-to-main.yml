name: ğŸ”„ Auto-merge Staging to Main

on:
  workflow_run:
    workflows: ["ğŸš€ Staging to Production Pipeline"]
    types: [completed]
    branches: [staging]

env:
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  auto-merge:
    name: ğŸ”„ Auto-merge to Main
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸ”§ Configure Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "action@github.com"

      - name: ğŸ”„ Merge Staging to Main
        run: |
          echo "ğŸ”„ Merging staging to main..."
          
          # Switch to main branch
          git checkout main
          git pull origin main
          
          # Merge staging into main
          git merge origin/staging --no-ff -m "ğŸš€ Auto-merge staging to main after successful tests

          - All security and quality gates passed
          - Functional tests completed successfully
          - Ready for production deployment
          
          Automated by GitHub Actions workflow: ${{ github.event.workflow_run.html_url }}"
          
          # Push to main
          git push origin main
          
          echo "âœ… Successfully merged staging to main"

      - name: ğŸ·ï¸ Create Release Tag
        run: |
          # Create a release tag with timestamp
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          TAG="release-$TIMESTAMP"
          
          git tag -a "$TAG" -m "Release $TAG - Auto-merged from staging"
          git push origin "$TAG"
          
          echo "ğŸ·ï¸ Created release tag: $TAG"

      - name: ğŸ“¢ Notify Success
        run: |
          echo "ğŸ‰ Auto-merge completed successfully!"
          echo "ğŸ“… Merged at: $(date)"
          echo "ğŸ·ï¸ Release tag: release-$(date +%Y%m%d-%H%M%S)"
          echo "ğŸš€ Production deployment should trigger automatically"
